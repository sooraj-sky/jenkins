pipeline {
    agent any
    
    stages {
        stage('Modify Version') {
            steps {
                script {
                    def key1 = 'djangotag'
                    def key2 = 'djangotag2'
                    def buildId = env.BUILD_NUMBER.toInteger()
                    def pocBuild = "poc-${buildId}"
                    
                    sh """#!/bin/bash
                        # Create a temporary file to store the modified contents
                        temp_file=\$(mktemp)

                        # Read the file line by line, replace the target key's value, and write to the temporary file
                        while IFS=':' read -r k v; do
                            if [[ \$k == '$key1' ]]; then
                                echo \"\$k:${pocBuild}\" >> \"\$temp_file\"
                            else
                                echo \"\$k:\$v\" >> \"\$temp_file\"
                            fi
                        done < 'version.txt'

                        # Replace the original file with the modified contents
                        mv \"\$temp_file\" 'version.txt'

                        echo 'Replacement complete.'

                        # Read the file again to update djangotag2 after other replacements
                        temp_file=\$(mktemp)

                        # Read the file line by line, replace the target key's value, and write to the temporary file
                        while IFS=':' read -r k v; do
                            if [[ \$k == '$key2' ]]; then
                                version=\$(echo \$v | awk -F. -v buildId=\$buildId '{\$3+=1; print \$1\".\"\$2\".\"\$3}')
                                echo \"\$k:\$version\" >> \"\$temp_file\"
                            else
                                echo \"\$k:\$v\" >> \"\$temp_file\"
                            fi
                        done < 'version.txt'

                        # Replace the original file with the modified contents
                        mv \"\$temp_file\" 'version.txt'

                        echo 'djangotag2 updated.'
                    """
                }
            }
        }
    }
}
